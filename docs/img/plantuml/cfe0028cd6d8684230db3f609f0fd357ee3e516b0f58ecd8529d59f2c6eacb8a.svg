<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="777px" preserveAspectRatio="none" style="width:1027px;height:777px;" version="1.1" viewBox="0 0 1027 777" width="1027px" zoomAndPan="magnify"><defs/><g><rect fill="#F0F0FF" height="746.9844" style="stroke: #FFFFFF; stroke-width: 1.0;" width="509.5" x="450.5" y="4"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="637.25" y="16.0669">Attacker's Session</text><line style="stroke: #AAAAAA; stroke-width: 1.0;" x1="67" x2="67" y1="54.4297" y2="433.6875"/><line style="stroke: #AAAAAA; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="67" x2="67" y1="433.6875" y2="474.4922"/><line style="stroke: #AAAAAA; stroke-width: 1.0;" x1="67" x2="67" y1="474.4922" y2="716.6875"/><line style="stroke: #AAAAAA; stroke-width: 1.0;" x1="327.5" x2="327.5" y1="54.4297" y2="433.6875"/><line style="stroke: #AAAAAA; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="327.5" x2="327.5" y1="433.6875" y2="474.4922"/><line style="stroke: #AAAAAA; stroke-width: 1.0;" x1="327.5" x2="327.5" y1="474.4922" y2="716.6875"/><line style="stroke: #AAAAAA; stroke-width: 1.0;" x1="412.5" x2="412.5" y1="54.4297" y2="433.6875"/><line style="stroke: #AAAAAA; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="412.5" x2="412.5" y1="433.6875" y2="474.4922"/><line style="stroke: #AAAAAA; stroke-width: 1.0;" x1="412.5" x2="412.5" y1="474.4922" y2="716.6875"/><line style="stroke: #AAAAAA; stroke-width: 1.0;" x1="489.5" x2="489.5" y1="54.4297" y2="433.6875"/><line style="stroke: #AAAAAA; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="489.5" x2="489.5" y1="433.6875" y2="474.4922"/><line style="stroke: #AAAAAA; stroke-width: 1.0;" x1="489.5" x2="489.5" y1="474.4922" y2="716.6875"/><line style="stroke: #AAAAAA; stroke-width: 1.0;" x1="757.5" x2="757.5" y1="54.4297" y2="433.6875"/><line style="stroke: #AAAAAA; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="757.5" x2="757.5" y1="433.6875" y2="474.4922"/><line style="stroke: #AAAAAA; stroke-width: 1.0;" x1="757.5" x2="757.5" y1="474.4922" y2="716.6875"/><line style="stroke: #AAAAAA; stroke-width: 1.0;" x1="924" x2="924" y1="54.4297" y2="433.6875"/><line style="stroke: #AAAAAA; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="924" x2="924" y1="433.6875" y2="474.4922"/><line style="stroke: #AAAAAA; stroke-width: 1.0;" x1="924" x2="924" y1="474.4922" y2="716.6875"/><rect fill="#375A7F" height="30.2969" style="stroke: #375A7F; stroke-width: 1.5;" width="118" x="8" y="23.1328"/><text fill="#FFFFFF" font-family="Roboto" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="15" y="43.1279">User's Browser</text><rect fill="#375A7F" height="30.2969" style="stroke: #375A7F; stroke-width: 1.5;" width="118" x="8" y="715.6875"/><text fill="#FFFFFF" font-family="Roboto" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="15" y="735.6826">User's Browser</text><rect fill="#375A7F" height="30.2969" style="stroke: #375A7F; stroke-width: 1.5;" width="85" x="285.5" y="23.1328"/><text fill="#FFFFFF" font-family="Roboto" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="292.5" y="43.1279">client.com</text><rect fill="#375A7F" height="30.2969" style="stroke: #375A7F; stroke-width: 1.5;" width="85" x="285.5" y="715.6875"/><text fill="#FFFFFF" font-family="Roboto" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="292.5" y="735.6826">client.com</text><rect fill="#375A7F" height="30.2969" style="stroke: #375A7F; stroke-width: 1.5;" width="64" x="380.5" y="23.1328"/><text fill="#FFFFFF" font-family="Roboto" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="50" x="387.5" y="43.1279">as.com</text><rect fill="#375A7F" height="30.2969" style="stroke: #375A7F; stroke-width: 1.5;" width="64" x="380.5" y="715.6875"/><text fill="#FFFFFF" font-family="Roboto" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="50" x="387.5" y="735.6826">as.com</text><rect fill="#F08080" height="30.2969" style="stroke: #375A7F; stroke-width: 1.5;" width="71" x="454.5" y="23.1328"/><text fill="#FFFFFF" font-family="Roboto" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="461.5" y="43.1279">Attacker</text><rect fill="#F08080" height="30.2969" style="stroke: #375A7F; stroke-width: 1.5;" width="71" x="454.5" y="715.6875"/><text fill="#FFFFFF" font-family="Roboto" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="461.5" y="735.6826">Attacker</text><rect fill="#375A7F" height="30.2969" style="stroke: #375A7F; stroke-width: 1.5;" width="85" x="715.5" y="23.1328"/><text fill="#FFFFFF" font-family="Roboto" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="722.5" y="43.1279">client.com</text><rect fill="#375A7F" height="30.2969" style="stroke: #375A7F; stroke-width: 1.5;" width="85" x="715.5" y="715.6875"/><text fill="#FFFFFF" font-family="Roboto" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="722.5" y="735.6826">client.com</text><rect fill="#375A7F" height="30.2969" style="stroke: #375A7F; stroke-width: 1.5;" width="64" x="892" y="23.1328"/><text fill="#FFFFFF" font-family="Roboto" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="50" x="899" y="43.1279">as.com</text><rect fill="#375A7F" height="30.2969" style="stroke: #375A7F; stroke-width: 1.5;" width="64" x="892" y="715.6875"/><text fill="#FFFFFF" font-family="Roboto" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="50" x="899" y="735.6826">as.com</text><polygon fill="#375A7F" points="316,81.5625,326,85.5625,316,89.5625,320,85.5625" style="stroke: #375A7F; stroke-width: 1.0;"/><line style="stroke: #375A7F; stroke-width: 1.0;" x1="67" x2="322" y1="85.5625" y2="85.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="74" y="80.4966">Use https://as.com (with Nonce)</text><polygon fill="#375A7F" points="78,171.2266,68,175.2266,78,179.2266,74,175.2266" style="stroke: #375A7F; stroke-width: 1.0;"/><line style="stroke: #375A7F; stroke-width: 1.0;" x1="72" x2="327" y1="175.2266" y2="175.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="84" y="109.6294">Location: https://as.com/auth</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="116" y="124.7622">?redirect_uri=https://client.com/</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="132" y="139.895">&amp;client_id=client_at_as</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="132" y="155.0278"/><text fill="#008000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="132" y="155.0278">&amp;nonce=</text><text fill="#008000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="8" x="193" y="155.0278">n</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="132" y="170.1606">&amp;...</text><polygon fill="#375A7F" points="400.5,200.3594,410.5,204.3594,400.5,208.3594,404.5,204.3594" style="stroke: #375A7F; stroke-width: 1.0;"/><line style="stroke: #375A7F; stroke-width: 1.0;" x1="67" x2="406.5" y1="204.3594" y2="204.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="74" y="199.2935">GET https://as.com/auth?...</text><polygon fill="#375A7F" points="78,229.4922,68,233.4922,78,237.4922,74,233.4922" style="stroke: #375A7F; stroke-width: 1.0;"/><polygon fill="#375A7F" points="400.5,229.4922,410.5,233.4922,400.5,237.4922,404.5,233.4922" style="stroke: #375A7F; stroke-width: 1.0;"/><line style="stroke: #375A7F; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="72" x2="406.5" y1="233.4922" y2="233.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="84" y="228.4263">user authentication, authorization</text><polygon fill="#375A7F" points="78,273.7578,68,277.7578,78,281.7578,74,277.7578" style="stroke: #375A7F; stroke-width: 1.0;"/><line style="stroke: #375A7F; stroke-width: 1.0;" x1="72" x2="411.5" y1="277.7578" y2="277.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="84" y="257.5591">Redirect to https://client.com/?code=c</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="76" x="116" y="272.6919">&amp;id_token=</text><text fill="#008000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="192" y="272.6919">{"nonce":</text><text fill="#008000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="8" x="253" y="272.6919">n</text><text fill="#008000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="261" y="272.6919">, "c_hash":hash(</text><text fill="#008000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="7" x="364" y="272.6919">c</text><text fill="#008000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="13" x="371" y="272.6919">)}</text><polygon fill="#375A7F" points="478,302.8906,488,306.8906,478,310.8906,482,306.8906" style="stroke: #375A7F; stroke-width: 1.0;"/><line style="stroke: #375A7F; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="67" x2="484" y1="306.8906" y2="306.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="33" x="74" y="301.8247">Code</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="7" x="111" y="301.8247">c</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="122" y="301.8247">leaks to attacker (Referer, etc.)</text><polygon fill="#375A7F" points="746,332.0234,756,336.0234,746,340.0234,750,336.0234" style="stroke: #375A7F; stroke-width: 1.0;"/><line style="stroke: #375A7F; stroke-width: 1.0;" x1="490" x2="752" y1="336.0234" y2="336.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="497" y="330.9575">Use https://as.com (with PKCE)</text><polygon fill="#375A7F" points="501,421.6875,491,425.6875,501,429.6875,497,425.6875" style="stroke: #375A7F; stroke-width: 1.0;"/><line style="stroke: #375A7F; stroke-width: 1.0;" x1="495" x2="757" y1="425.6875" y2="425.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="507" y="360.0903">Location: https://as.com/auth</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="539" y="375.2231">?redirect_uri=https://client.com/</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="555" y="390.356">&amp;client_id=client_at_as</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="555" y="405.4888"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="555" y="405.4888">&amp;code_challenge=sha256(</text><text fill="#0000FF" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="14" x="728" y="405.4888">cv</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="742" y="405.4888">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="555" y="420.6216">&amp;...</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="365" x="313" y="457.8979">The attacker can skip the authentication/authorization at the AS.</text><polygon fill="#375A7F" points="746,491.625,756,495.625,746,499.625,750,495.625" style="stroke: #375A7F; stroke-width: 1.0;"/><line style="stroke: #375A7F; stroke-width: 1.0;" x1="490" x2="752" y1="495.625" y2="495.625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="237" x="497" y="490.5591">Redirect to https://client.com/?code=</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="7" x="734" y="490.5591">c</text><polygon fill="#375A7F" points="912,551.0234,922,555.0234,912,559.0234,916,555.0234" style="stroke: #375A7F; stroke-width: 1.0;"/><line style="stroke: #375A7F; stroke-width: 1.0;" x1="758" x2="918" y1="555.0234" y2="555.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="765" y="519.6919">POST /token?code=</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="7" x="892" y="519.6919">c</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="781" y="534.8247"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="781" y="534.8247">&amp;code_verifier=</text><text fill="#0000FF" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="14" x="884" y="534.8247">cv</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="781" y="549.9575">&amp;...</text><path d="M838,568.0234 L838,593.0234 L1010,593.0234 L1010,578.0234 L1000,568.0234 L838,568.0234 " fill="#FFCEB5" style="stroke: #FFCEB5; stroke-width: 1.0;"/><path d="M1000,568.0234 L1000,578.0234 L1010,578.0234 L1000,568.0234 " fill="#FFCEB5" style="stroke: #FFCEB5; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="844" y="585.0903">AS ignores code verifier</text><polygon fill="#375A7F" points="769,630.4219,759,634.4219,769,638.4219,765,634.4219" style="stroke: #375A7F; stroke-width: 1.0;"/><line style="stroke: #375A7F; stroke-width: 1.0;" x1="763" x2="923" y1="634.4219" y2="634.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="775" y="614.2231">access token,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="775" y="629.356">id_token=</text><text fill="#008000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="840" y="629.356">{"nonce":</text><text fill="#008000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="8" x="901" y="629.356">n</text><text fill="#008000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="909" y="629.356">}</text><path d="M682,647.4219 L682,672.4219 L833,672.4219 L833,657.4219 L823,647.4219 L682,647.4219 " fill="#FFCEB5" style="stroke: #FFCEB5; stroke-width: 1.0;"/><path d="M823,647.4219 L823,657.4219 L833,657.4219 L823,647.4219 " fill="#FFCEB5" style="stroke: #FFCEB5; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="688" y="664.4888">Client ignores nonce</text><polygon fill="#375A7F" points="501,694.6875,491,698.6875,501,702.6875,497,698.6875" style="stroke: #375A7F; stroke-width: 1.0;"/><polygon fill="#375A7F" points="746,694.6875,756,698.6875,746,702.6875,750,698.6875" style="stroke: #375A7F; stroke-width: 1.0;"/><line style="stroke: #375A7F; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="495" x2="752" y1="698.6875" y2="698.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="507" y="693.6216">Use access token via the client</text><text fill="#888888" font-family="sans-serif" font-size="10" lengthAdjust="spacingAndGlyphs" textLength="61" x="954" y="764.2666">danielfett.de</text><!--MD5=[c5f85cf1cfc7b55a54324643f36dc274]
@startuml
hide stereotype
skinparam shadowing false
skinparam sequence {
ArrowColor #375a7f
LifeLineBorderColor #aaa
BoundaryBackgroundColor #f00

ParticipantBorderColor #375a7f
ParticipantBackgroundColor #375a7f
ParticipantFontColor #fff
ParticipantFontName Roboto
ParticipantFontSize 14

BoxBackgroundColor #f0f0ff
BoxBorderColor transparent
ParticipantBackgroundColor<<Attacker>> #F08080
}

skinparam note {
BackgroundColor #CEE1F5
BorderColor #CEE1F5
FontColor #000

BackgroundColor<<warning>> #FFCEB5
BorderColor<<warning>> #FFCEB5

BackgroundColor<<ok>> #C6EAA6
BorderColor<<ok>> #C6EAA6
}

right footer danielfett.de

participant "User's Browser" as Browser
participant client.com
participant as.com

box Attacker's Session
participant Attacker <<Attacker>>
participant client.com as client.com2
participant as.com as as.com2
endbox

Browser -> client.com: Use https://as.com (with Nonce)
client.com -> Browser: Location: https://as.com/auth\n        ?redirect_uri=https://client.com/\n            &client_id=client_at_as\n            <font color=green>&nonce=<i>n</i>\n            &...

Browser -> as.com: GET https://as.com/auth?...
Browser <- -> as.com: user authentication, authorization
as.com -> Browser: Redirect to https://client.com/?code=c\n        &id_token=<font color=green>{"nonce":<i>n</i>, "c_hash":hash(<i>c</i>)}
Browser - -> Attacker: Code <font color=red><i>c</i></font> leaks to attacker (Referer, etc.)

Attacker -> client.com2: Use https://as.com (with PKCE)
client.com2 -> Attacker: Location: https://as.com/auth\n        ?redirect_uri=https://client.com/\n            &client_id=client_at_as\n            <font color=blue>&code_challenge=sha256(<i>cv</i>)\n            &...

... The attacker can skip the authentication/authorization at the AS. ...
Attacker -> client.com2: Redirect to https://client.com/?code=<font color=red><i>c</i></font>
client.com2 -> as.com2: POST /token?code=<font color=red><i>c</i></font>\n    <font color=blue>&code_verifier=<i>cv</i>\n    &...
note<<warning>> over as.com2: AS ignores code verifier
as.com2 -> client.com2: access token, \nid_token=<font color=green>{"nonce":<i>n</i>}
note<<warning>> over client.com2: Client ignores nonce
Attacker <- -> client.com2: Use access token via the client
@enduml

PlantUML version 1.2020.08(Sun Apr 26 14:08:22 UTC 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_252-b09
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: null
--></g></svg>