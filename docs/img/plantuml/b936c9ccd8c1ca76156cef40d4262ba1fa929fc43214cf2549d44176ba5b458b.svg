<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="807px" preserveAspectRatio="none" style="width:878px;height:807px;" version="1.1" viewBox="0 0 878 807" width="878px" zoomAndPan="magnify"><defs/><g><line style="stroke: #AAAAAA; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="67" x2="67" y1="34.2969" y2="750.2813"/><line style="stroke: #AAAAAA; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="342.5" x2="342.5" y1="34.2969" y2="750.2813"/><line style="stroke: #AAAAAA; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="614.5" x2="614.5" y1="34.2969" y2="750.2813"/><line style="stroke: #AAAAAA; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="781" x2="781" y1="34.2969" y2="750.2813"/><rect fill="#375A7F" height="30.2969" style="stroke: #375A7F; stroke-width: 1.5;" width="118" x="8" y="3"/><text fill="#FFFFFF" font-family="Roboto" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="15" y="22.9951">User's Browser</text><rect fill="#375A7F" height="30.2969" style="stroke: #375A7F; stroke-width: 1.5;" width="118" x="8" y="749.2813"/><text fill="#FFFFFF" font-family="Roboto" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="15" y="769.2764">User's Browser</text><rect fill="#F08080" height="30.2969" style="stroke: #375A7F; stroke-width: 1.5;" width="71" x="307.5" y="3"/><text fill="#FFFFFF" font-family="Roboto" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="314.5" y="22.9951">Attacker</text><rect fill="#F08080" height="30.2969" style="stroke: #375A7F; stroke-width: 1.5;" width="71" x="307.5" y="749.2813"/><text fill="#FFFFFF" font-family="Roboto" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="314.5" y="769.2764">Attacker</text><rect fill="#375A7F" height="30.2969" style="stroke: #375A7F; stroke-width: 1.5;" width="85" x="572.5" y="3"/><text fill="#FFFFFF" font-family="Roboto" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="579.5" y="22.9951">client.com</text><rect fill="#375A7F" height="30.2969" style="stroke: #375A7F; stroke-width: 1.5;" width="85" x="572.5" y="749.2813"/><text fill="#FFFFFF" font-family="Roboto" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="579.5" y="769.2764">client.com</text><rect fill="#375A7F" height="30.2969" style="stroke: #375A7F; stroke-width: 1.5;" width="64" x="749" y="3"/><text fill="#FFFFFF" font-family="Roboto" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="50" x="756" y="22.9951">as.com</text><rect fill="#375A7F" height="30.2969" style="stroke: #375A7F; stroke-width: 1.5;" width="64" x="749" y="749.2813"/><text fill="#FFFFFF" font-family="Roboto" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="50" x="756" y="769.2764">as.com</text><polygon fill="#375A7F" points="603,61.4297,613,65.4297,603,69.4297,607,65.4297" style="stroke: #375A7F; stroke-width: 1.0;"/><line style="stroke: #375A7F; stroke-width: 1.0;" x1="67" x2="609" y1="65.4297" y2="65.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="74" y="60.3638">Use https://as.com</text><polygon fill="#375A7F" points="78,151.0938,68,155.0938,78,159.0938,74,155.0938" style="stroke: #375A7F; stroke-width: 1.0;"/><line style="stroke: #375A7F; stroke-width: 1.0;" x1="72" x2="614" y1="155.0938" y2="155.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="84" y="89.4966">Location: https://as.com/auth</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="116" y="104.6294">?redirect_uri=https://client.com/</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="132" y="119.7622">&amp;client_id=client_at_as</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="132" y="134.895"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="132" y="134.895">&amp;code_challenge=sha256(</text><text fill="#0000FF" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="14" x="305" y="134.895">cv</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="319" y="134.895">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="132" y="150.0278">&amp;...</text><polygon fill="#375A7F" points="769,180.2266,779,184.2266,769,188.2266,773,184.2266" style="stroke: #375A7F; stroke-width: 1.0;"/><line style="stroke: #375A7F; stroke-width: 1.0;" x1="67" x2="775" y1="184.2266" y2="184.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="74" y="179.1606">GET https://as.com/auth?...</text><polygon fill="#375A7F" points="78,209.3594,68,213.3594,78,217.3594,74,213.3594" style="stroke: #375A7F; stroke-width: 1.0;"/><polygon fill="#375A7F" points="769,209.3594,779,213.3594,769,217.3594,773,213.3594" style="stroke: #375A7F; stroke-width: 1.0;"/><line style="stroke: #375A7F; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="72" x2="775" y1="213.3594" y2="213.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="84" y="208.2935">user authentication, authorization</text><path d="M24,226.3594 L24,251.3594 L824,251.3594 L824,236.3594 L814,226.3594 L24,226.3594 " fill="#CEE1F5" style="stroke: #CEE1F5; stroke-width: 1.0;"/><path d="M814,226.3594 L814,236.3594 L824,236.3594 L814,226.3594 " fill="#CEE1F5" style="stroke: #CEE1F5; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212" x="313.5" y="243.4263">User's session will not be finished</text><polygon fill="#375A7F" points="603,273.625,613,277.625,603,281.625,607,277.625" style="stroke: #375A7F; stroke-width: 1.0;"/><line style="stroke: #375A7F; stroke-width: 1.0;" x1="343" x2="609" y1="277.625" y2="277.625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="350" y="272.5591">Use https://as.com</text><polygon fill="#375A7F" points="354,363.2891,344,367.2891,354,371.2891,350,367.2891" style="stroke: #375A7F; stroke-width: 1.0;"/><line style="stroke: #375A7F; stroke-width: 1.0;" x1="348" x2="614" y1="367.2891" y2="367.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="360" y="301.6919">Location: https://as.com/auth</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="392" y="316.8247">?redirect_uri=https://client.com/</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="408" y="331.9575">&amp;client_id=client_at_as</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="408" y="347.0903"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="408" y="347.0903">&amp;code_challenge=sha256(</text><text fill="#0000FF" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="22" x="581" y="347.0903">cv2</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="603" y="347.0903">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="408" y="362.2231">&amp;...</text><path d="M188,380.2891 L188,420.2891 L498,420.2891 L498,390.2891 L488,380.2891 L188,380.2891 " fill="#CEE1F5" style="stroke: #CEE1F5; stroke-width: 1.0;"/><path d="M488,380.2891 L488,390.2891 L498,390.2891 L488,380.2891 " fill="#CEE1F5" style="stroke: #CEE1F5; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="194" y="397.356">Attacker removes code_challenge parameter</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="194" y="412.4888">from authorization request.</text><polygon fill="#375A7F" points="769,488.0859,779,492.0859,769,496.0859,773,492.0859" style="stroke: #375A7F; stroke-width: 1.0;"/><line style="stroke: #375A7F; stroke-width: 1.0;" x1="343" x2="775" y1="492.0859" y2="492.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="350" y="441.6216">GET https://as.com/auth</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="382" y="456.7544">?redirect_uri=https://client.com/</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="398" y="471.8872">&amp;client_id=client_at_as</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="398" y="487.02">&amp;...</text><polygon fill="#375A7F" points="354,517.2188,344,521.2188,354,525.2188,350,521.2188" style="stroke: #375A7F; stroke-width: 1.0;"/><polygon fill="#375A7F" points="769,517.2188,779,521.2188,769,525.2188,773,521.2188" style="stroke: #375A7F; stroke-width: 1.0;"/><line style="stroke: #375A7F; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="348" x2="775" y1="521.2188" y2="521.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="241" x="360" y="516.1528">attacker authentication, authorization</text><polygon fill="#375A7F" points="354,546.3516,344,550.3516,354,554.3516,350,550.3516" style="stroke: #375A7F; stroke-width: 1.0;"/><line style="stroke: #375A7F; stroke-width: 1.0;" x1="348" x2="780" y1="550.3516" y2="550.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="237" x="360" y="545.2856">Redirect to https://client.com/?code=</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="15" x="597" y="545.2856">c2</text><polygon fill="#375A7F" points="78,575.4844,68,579.4844,78,583.4844,74,579.4844" style="stroke: #375A7F; stroke-width: 1.0;"/><line style="stroke: #375A7F; stroke-width: 1.0;" x1="72" x2="342" y1="579.4844" y2="579.4844"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="237" x="84" y="574.4185">Redirect to https://client.com/?code=</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="15" x="321" y="574.4185">c2</text><polygon fill="#375A7F" points="603,604.6172,613,608.6172,603,612.6172,607,608.6172" style="stroke: #375A7F; stroke-width: 1.0;"/><line style="stroke: #375A7F; stroke-width: 1.0;" x1="67" x2="609" y1="608.6172" y2="608.6172"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="74" y="603.5513">GET https://client.com/?code=</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="15" x="267" y="603.5513">c2</text><polygon fill="#375A7F" points="769,664.0156,779,668.0156,769,672.0156,773,668.0156" style="stroke: #375A7F; stroke-width: 1.0;"/><line style="stroke: #375A7F; stroke-width: 1.0;" x1="615" x2="775" y1="668.0156" y2="668.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="622" y="632.6841">POST /token?code=</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="15" x="749" y="632.6841">c2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="638" y="647.8169"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="638" y="647.8169">&amp;code_verifier=</text><text fill="#0000FF" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="14" x="741" y="647.8169">cv</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="638" y="662.9497">&amp;redirect_uri=...</text><path d="M700,681.0156 L700,706.0156 L861,706.0156 L861,691.0156 L851,681.0156 L700,681.0156 " fill="#FFCEB5" style="stroke: #FFCEB5; stroke-width: 1.0;"/><path d="M851,681.0156 L851,691.0156 L861,691.0156 L851,681.0156 " fill="#FFCEB5" style="stroke: #FFCEB5; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="706" y="698.0825">No PKCE check at AS!</text><polygon fill="#375A7F" points="626,728.2813,616,732.2813,626,736.2813,622,732.2813" style="stroke: #375A7F; stroke-width: 1.0;"/><line style="stroke: #375A7F; stroke-width: 1.0;" x1="620" x2="780" y1="732.2813" y2="732.2813"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="632" y="727.2153">access token</text><text fill="#888888" font-family="sans-serif" font-size="10" lengthAdjust="spacingAndGlyphs" textLength="61" x="805" y="793.8604">danielfett.de</text><!--MD5=[46b74b1b67b8a0442e4dca8129851abe]
@startuml
hide stereotype
skinparam shadowing false
skinparam sequence {
ArrowColor #375a7f
LifeLineBorderColor #aaa
BoundaryBackgroundColor #f00

ParticipantBorderColor #375a7f
ParticipantBackgroundColor #375a7f
ParticipantFontColor #fff
ParticipantFontName Roboto
ParticipantFontSize 14

BoxBackgroundColor #f0f0ff
BoxBorderColor transparent
ParticipantBackgroundColor<<Attacker>> #F08080
}

skinparam note {
BackgroundColor #CEE1F5
BorderColor #CEE1F5
FontColor #000

BackgroundColor<<warning>> #FFCEB5
BorderColor<<warning>> #FFCEB5

BackgroundColor<<ok>> #C6EAA6
BorderColor<<ok>> #C6EAA6
}

right footer danielfett.de
participant "User's Browser" as Browser
participant Attacker <<Attacker>>
participant client.com
participant as.com


Browser -> client.com: Use https://as.com
client.com -> Browser: Location: https://as.com/auth\n        ?redirect_uri=https://client.com/\n            &client_id=client_at_as\n            <font color=blue>&code_challenge=sha256(<i>cv</i>)\n            &...

Browser -> as.com: GET https://as.com/auth?...
Browser <- -> as.com: user authentication, authorization
note over Browser, as.com
User's session will not be finished
endnote

Attacker -> client.com: Use https://as.com
client.com -> Attacker: Location: https://as.com/auth\n        ?redirect_uri=https://client.com/\n            &client_id=client_at_as\n            <font color=blue>&code_challenge=sha256(<i>cv2</i>)\n            &...
note over Attacker
Attacker removes code_challenge parameter
from authorization request.
end note
Attacker -> as.com: GET https://as.com/auth\n        ?redirect_uri=https://client.com/\n            &client_id=client_at_as\n            &...
Attacker <- -> as.com: attacker authentication, authorization
as.com -> Attacker: Redirect to https://client.com/?code=<font color=red><i>c2</i></font>
Attacker -> Browser: <font color=red>Redirect to https://client.com/?code=<i>c2</i></font>

Browser -> client.com: GET https://client.com/?code=<font color=red><i>c2</i></font>
client.com -> as.com: POST /token?code=<font color=red><i>c2</i></font>\n    <font color=blue>&code_verifier=<i>cv</i>\n    &redirect_uri=...
note<<warning>> over as.com: No PKCE check at AS!
as.com -> client.com: <font color=red>access token
@enduml

PlantUML version 1.2020.08(Sun Apr 26 14:08:22 UTC 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_252-b09
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: null
--></g></svg>